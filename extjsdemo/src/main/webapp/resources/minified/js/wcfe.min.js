Ext.ns("Wcfe");

XType = {
	textfield : "textfield",
	button : "button",
	window : "window",
	panel : "panel",
	viewport : "viewport",
	clientform : "clientform",
	breadcrumb : "breadcrumb",
	datefield : "datefield",
	namefield : "namefield"
};

Wcfe = {

	supportsLocalStorage : function() {
		try {
			return 'localStorage' in window && window['localStorage'] !== null;
		} catch (e) {
			return false;
		}
	}
};

/**
 * 
 * This is a singleton class and can't be create directly
 * 
 * Use the init(); for create a new instance
 * 
 * @author kokeny
 */
Wcfe.App = function() {

	/**
	 * Current version
	 */
	var version = "1.0";

	/**
	 * Name of the application
	 */
	var name = "WCFE";

	/**
	 * Init user interface
	 */
	function initUI() {
		console.debug("Init application user interface");

		createViewPort();
	}

	function initStateProvider() {
		var stateProvider = null;
		if (Wcfe.supportsLocalStorage()) {
			stateProvider = new Wcfe.state.LocalStorageProvider();
		} else {
			stateProvider = new Ext.state.CookieProvider();
		}

		Ext.state.Manager.setProvider(stateProvider);
	}

	function createViewPort() {
		var content = createContent();

		var viewPort = Ext.create({
			layout : 'border',
			stateful : true,
			items : [ {
				xtype: "panel",
				region : "north",
				height: 100,
				items : [{	xtype : XType.breadcrumb}]
			
			}, {
				region : 'east',
				stateId : 'eastPanel',
				split : true,
				collapsible : true,
				width : 300,
				xtype : XType.panel,
			}, content ]
		}, XType.viewport);

		return viewPort;
	}

	function createContent() {
		var clientForm = Ext.create({}, "clientform");

		return Ext.create({
			region : 'center',
			items : [ clientForm ]
		}, XType.panel);
	}

	return {

		/**
		 * 
		 * @returns Return instance of the application
		 */
		getInstance : function() {
			return this;
		},

		/**
		 * 
		 * @returns Return instance of the application
		 */
		init : function() {
			initStateProvider();
			initUI();

			return this.getInstance();
		},

		/**
		 * 
		 * 
		 * @returns Return version of the application
		 */
		getVersion : function() {
			return version;
		},

		/**
		 * 
		 * @returns Return name of the application
		 */
		getName : function() {
			return name;
		}
	}
}();/**
 * This is a singleton class
 * 
 *  
 *  Register an action
 * <pre>
 * 	<code>
 * 		var action = new Ext.Action({
 * 			text : "Search clients",
 * 			itemId : "searchAction",
 * 			handler : function(){
 * 				//TODO implement action handler
 * 			}
 * 		});
 * 
 * 		ActionRegistry.reg(action);
 *  </code>
 * </pre>
 *   Get the action by actionId
 * <pre>
 * 	<code>
 * 		var action = ActionRegistry.getAction("searchAction");
 *  </code>
 * </pre>
 * 
 * @author Gabor Kokeny
 * @class ActionRegistry
 */
ActionRegistry = function() {

	/**
	 * Registered actions
	 */
	var actions = {};

	var get = function(actionId) {
		return actions[actionId];
	};

	var put = function(actionId, action) {
		actions[actionId] = action;
	};

	var remove = function(acitonId) {
		delete actions[actionId];
	};

	return {
		
		/**
		 * Get action by actionId
		 * 
		 * @param actionId The id of the action
		 * @return Return the registered action
		 */
		getAction : function(actionId) {
			if (actionId == null) {
				throw "Method parameter 'actionId' cannot be null";
			}

			var action = get(actionId);

			if (!Ext.isDefined(action) || action == null) {
				throw "There is no action with actionId " + actionId;
			}

			return action;
		},
		
		/**
		 * Register an action
		 * 
		 * @param action The action object
		 */
		reg : function(action) {
			put(action.itemId, action);
			console.debug("Action %s has been registered ", action.itemId);
		},

		/**
		 * Unregister an action by actionId;
		 * 
		 * @param {string} actionId The id of the action
		 */
		unreg : function(actionId) {
			remove(actionId);
			console.debug("Action %s has been unregistered ", actionId);
		}
	}
}();


var clientAction = new Ext.Action({

	text : 'Ügyfél adatok',

	iconCls : 'do-something',

	itemId : 'clientAction',

	handler : function() {

		Ext.Msg.alert('Ügyfél adatok megjelenítése');
	},
});

ActionRegistry.reg(clientAction);


var searchAction = new Ext.Action({

	text : 'Ügyfél keresés',

	iconCls : 'do-something',

	itemId : 'searchAction',

	handler : function() {
		Ext.Msg.alert('Ügyfél keresés');
	},
});

ActionRegistry.reg(searchAction);
Ext.ns("Wcfe.component");

/**
 * Breadcrumb implementation
 * 
 * @xtype breadcrumb
 * @class Wcfe.component.Breadcrumb
 */
Wcfe.component.Breadcrumb = Ext.extend(Ext.Panel, {

	id : 'siteBreadcrumb',

	stateId : "siteBreadcrumb",

	stateful : true,

	actions : {},

	cls : 'x-breadcrumb',

	layout : "hbox",

	baseCls : 'x-plain',

	height : 100,

	layoutConfig : {
		align : 'middle'
	},

	initComponent : function() {

		this.addEvents(
		/**
		 * @event actionadded 
		 * This event fired via breadcrumb after an action successfully added.
		 */
		"actionadded");
		
		Wcfe.component.Breadcrumb.superclass.initComponent.call(this);
	},

	/**
	 * Init state events
	 */
	initStateEvents : function() {
		var me = this;

		Wcfe.component.Breadcrumb.superclass.initStateEvents.call(me);

		me.mon(me, 'actionadded', me.saveState, me);
	},

	/**
	 * We can use this function to add an action to breadcrumb.
	 * 
	 * 
	 * This method fire 'actionadded' after the action successfully added to
	 * breadcrumb
	 * 
	 * @param action
	 *            An action instance that we want to add the breadcrumb
	 */
	addAction : function(action) {
		if (!Ext.isDefined(action) || action == null) {
			throw "Method parameter 'action' cannot be null or undefined";
		}
		console.debug("Add an action to breadcrumb %O", action);

		this.add(new Ext.Button(action))

		this.actions[action.itemId] = action;

		this.doLayout();

		this.fireEvent("actionadded", action);
	},

	// private
	applyState : function(state) {
		console.debug("Apply %O state to Breadcrumb", state);

		var me = this;
		Ext.each(state.actions, function(actionId) {
			var action = ActionRegistry.getAction(actionId);
			me.addAction(action);
		});

		Wcfe.component.Breadcrumb.superclass.applyState.call(state);
	},

	/**
	 * Provide current state of this breadcrumb component
	 * 
	 * @return Return the state of breadcrumb
	 */
	getState : function() {
		var me = this;
		var state = {
			actions : me.getKeys(me.actions)
		};
		return state;
	},

	/**
	 * This is an helper method. We can use it to get all properties of an
	 * object.
	 * 
	 * @param {Object} object The object
	 * @return Return an array that contains all keys of the object
	 */
	getKeys : function(object) {
		var keys = [];

		for (key in object) {
			if (object.hasOwnProperty(key)) {
				keys.push(key);
			}
		}
		return keys;
	}
});

Ext.reg(XType.breadcrumb, Wcfe.component.Breadcrumb);
Ext.ns("Wcfe.field");

/**
 * This is a composite field
 * 
 * @author Gabor Kokeny
 * @xtype namefield
 */
Wcfe.field.NameField = Ext.extend(Ext.form.CompositeField, {
	
	/**
	 * @cfg {String} firstNameText
	 * Defaults to :  'Firstname'
	 * 
	 * Set the empty text of first name field
	 */
	firstNameText : "Firstname",

	/**
	 * @cfg {String} lastNameText
	 * Defaults to :  'Lastname'
	 * 
	 * Set the empty text of last name field
	 */
	lastNameText : "Lastname",

	initComponent : function() {
		var config = {};

		config.items = this.createItems();

		config = Ext.apply(this.initialConfig, config);
		Ext.apply(this, config);

		Wcfe.field.NameField.superclass.initComponent.call(this);
	},

	/**
	 * Create own items
	 * 
	 * @private
	 */
	createItems : function() {
		var items = [ {
			xtype : XType.textfield,
			emptyText : this.lastNameText,
			name : 'name.lastName'
		}, {
			xtype : XType.textfield,
			emptyText : this.firstNameText,
			name : 'name.firstName'
		} ];
		return items;
	}
});

Ext.reg(XType.namefield, Wcfe.field.NameField);Ext.ns("Wcfe.form");

Wcfe.form.AbstractFormPanel = Ext.extend(Ext.form.FormPanel, {
	
	initStateEvents : function() {
		var me = this;
		
		Wcfe.form.AbstractFormPanel.superclass.initStateEvents.call(me);
		me.mon(me, 'onsave', me.saveState, me);
		me.mon(me, 'onreset', me.saveState, me);

		this.iterateOwnItems(function(item) {
			item.mon(item, 'change', me.saveState, me);
			item.mon(item, 'change', me.onChange, me);
		});
	},

	iterateOwnItems : function(callback) {
		if (!Ext.isDefined(callback) || callback == null) {
			throw "Callback function cannot be null or undifined";
		}

		if (!this.items || !this.items.length) {
			return;
		}

		var iter = function(items) {
			items.each(function(item) {
				if (item.isComposite) {
					iter(item.items);
				}
				callback(item);
			});
		}
		iter(this.items);
	},

	initComponent : function() {
		var config = {};

		config.items = this.createItems();
		config.bbar = this.createBottomToolbar();

		config = Ext.apply(this.initialConfig, config);

		Ext.apply(this, config);

		Wcfe.form.AbstractFormPanel.superclass.initComponent.call(this);
	},

	createItems : function() {
		return [];
	},

	createBottomToolbar : function() {
		return [];
	},

	onChange : function() {
		console.debug("Form fields has been changed");
	},

	resetForm : function() {
		console.debug("Reset form values");

		this.iterateOwnItems(function(item) {
			item.setValue(null);
		});

		this.fireEvent('onreset');
	},

	saveForm : function() {
		console.debug("Save client form");

		var me = this;

		me.fireEvent('onsave');
		this.getForm().submit({
			clientValidation : true,
			submitEmptyText : false,
			success : me.onSaveSuccess,
			failure : me.onSaveFailure,
			waitTitle : "Please wait",
			waitMsg : "Please wait, save in progress"
		});
	},

	onSaveSuccess : function() {
		console.debug("Save success");
	},

	onSaveFailure : function() {
		console.debug("Save failed");
	},

	applyState : function(state) {
		console.debug("Apply %O state to ClientForm", state);
		this.getForm().setValues(state.formValues);
		
		Wcfe.form.AbstractFormPanel.superclass.applyState.call(state);
	},

	getState : function() {
		console.log("state", this);
		var state = {
			formValues : this.getForm().getValues(),
			width : this.getWidth(),
			height : this.getHeight()
		};
		return state;
	},
});
Ext.ns("Wcfe.form");

Wcfe.form.ClientFormPanel = Ext.extend(Wcfe.form.AbstractFormPanel, {

	cityLabel : "City",
	
	nameLabel : "Name",
	
	birthDateLabel : "Birthdate",
	
	resetText: "Reset",
	
	saveText : "Save",
	
	title : 'Search clients',
	
	stateId : 'clientform.state',

	createItems : function() {
		var items = [ {
			fieldLabel : this.cityLabel,
			xtype : "textfield",
			name : "city"
		}, {
			xtype : XType.namefield,
			fieldLabel : this.nameLabel
		}, {
			xtype : XType.datefield,
			name : 'birthDate',
			fieldLabel : this.birthDateLabel
		} ];
		return items;
	},

	createBottomToolbar : function() {
		this.btnReset = Ext.create({
			text : this.resetText,
			scope : this,
			handler : this.resetForm
		}, "button");

		this.btnSave = Ext.create({
			text : this.saveText,
			scope : this,
			handler : this.saveForm
		}, "button");
		

		this.btnAction = Ext.create({
			text : "Add action",
			scope : this,
			handler : this.addAction
		}, "button");

		var buttons = [ this.btnSave, this.btnReset, this.btnAction ];

		return buttons;
	},

	addAction : function(button, event){
		var breadcrumb = Ext.getCmp("siteBreadcrumb");
		breadcrumb.addAction(clientAction);
		breadcrumb.addAction(searchAction);
	
	}
});


Ext.reg("clientform", Wcfe.form.ClientFormPanel);


Ext.onReady(function() {

	var start = Date.now();

	App = Wcfe.App.init();

	var end = Date.now();
	var time = end - start;

	console.info("Application is ready now");
	console.info("Current version ", App.getVersion());
	console.info('Execution time: ' + time + " ms");
});
/**
 * Client form panel hungarian translation
 */
Ext.override(Wcfe.form.ClientFormPanel, {
	cityLabel : "Város",
	nameLabel : "Név",
	birthDateLabel : "Születési dátum",
	resetText : "Törlés",
	saveText : "Mentés",
	title : 'Ügyfelek keresése'
});
/**
 * NameField hungarian translation
 */
Ext.override(Wcfe.field.NameField, {
	firstNameText : "Keresztnév",
	lastNameText : "Vezetéknév",
});

/**
 * Temporaly solution
 */
Ext.override(Ext.form.BasicForm, {

	nestedSeparator : '.',

	doSetValues : function(values, form, parentId) {
		var field, id, value;
		for (id in values) {
			value = values[id];
			id = Ext.isDefined(parentId) ? parentId + this.nestedSeparator + id
					: id;

			if (Ext.isObject(value)) {
				form.doSetValues(value, form, id);
			}

			field = this.findField(id);

			if (!Ext.isFunction(value) && field) {
				field.setValue(value);
				console.debug("Set field value: ", id, values, value);
				if (this.trackResetOnLoad) {
					field.originalValue = field.getValue();
				}
			}
		}
	},

	setValues : function(values) {
		if (Ext.isArray(values)) {
			for (var i = 0, len = values.length; i < len; i++) {
				var v = values[i];
				this.doSetValues(v, this);
			}
		} else { // object hash
			this.doSetValues(values, this);
		}
		return this;
	},

});Ext.ns("Wcfe.state");

/**
 * @class Wcfe.state.LocalStorageProvider
 * @extend Ext.state.Provider
 * 
 * Custom state provider implementation. LocalStorageProvider use the HTML5
 * localstorage for save state of objects.
 * 
 * How to use this Provider:
 * 
 * <pre>
 * <code>
 * var stateProvider = new Wcfe.state.LocalStorageProvider();
 * Ext.state.Manager.setProvider(stateProvider);
 * </code>
 * </pre>
 * 
 * @author Gabor Kokeny
 */
Wcfe.state.LocalStorageProvider = Ext
		.extend(
				Ext.state.Provider,
				{

					/**
					 * 
					 * Default constructor we can use this for create a new
					 * instance of LocalStorageProvider
					 * 
					 * @throws {String}
					 *             Throw an exception when the HTML5
					 *             localStorage is not supported
					 */
					constructor : function() {
						if (!Wcfe.supportsLocalStorage()) {
							throw "Couldn't initialize LocalStorageProvider because your browser is not supports the HTML5 localStorage";
						}

						Wcfe.state.LocalStorageProvider.superclass.constructor
								.call(this);

						// Delete unused variable
						delete this.state;

						console.debug("LocalStorageProvider initialized", this);
					},

					/**
					 * 
					 * @param key
					 *            The key of state
					 * @param defaultValue
					 *            The defaultValue
					 * 
					 * @returns If localStorage contains key then return the
					 *          current value else return the defaultValue
					 */
					get : function(key, defaultValue) {
						var value = localStorage.getItem(key);

						if (value == null) {
							console
									.warn(
											"There is no value in localstorage with key",
											key);
							return defaultValue;
						}

						value = this.decodeValue(value);

						console.debug("LocalStorageProvider - get state of '"
								+ key + "'", value);

						return value;
					},

					/**
					 * Set value in localStorage
					 * 
					 * @param name
					 *            The key of state
					 * @param value
					 *            The current valu e of state
					 */
					set : function(key, value) {
						if (typeof value == 'undefined' || value === null) {
							this.clear(key);
							return;
						}
						console.debug("LocalStorageProvider - set state of '"
								+ key + "'", value);

						localStorage.setItem(key, this.encodeValue(value));

						this.fireEvent("statechange", this, key, null);
					},

					/**
					 * Remove item from the localeStorage by a key
					 * 
					 * @param name
					 *            The key of state
					 */
					clear : function(key) {
						console.debug("LocalStorageProvider - clear state of '"
								+ key + "'");

						localStorage.removeItem(key);

						this.fireEvent("statechange", this, key, value);
					}

				});